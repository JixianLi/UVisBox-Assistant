# v0.3.5 Unit Test Isolation Design

**Date:** 2025-11-05
**Version:** v0.3.5
**Goal:** Make `tests/unit/` truly zero-dependency by mocking all external calls

## Problem

Unit tests currently call real UVisBox functions and generate real data files. When UVisBox is not installed, tests fail. This violates the principle that unit tests should test logic in isolation with all external dependencies mocked.

## Solution

Replace all real UVisBox/data calls in `tests/unit/test_tools.py` with mocked tests that verify non-trivial logic paths only.

---

## Overall Approach

**Objective**: Make `tests/unit/` run without UVisBox installation

**Changes:**
1. Delete all tests that call real UVisBox
2. Replace with mocked tests covering non-trivial logic paths only
3. Mock both `load_array()` and UVisBox functions
4. Keep existing exception-handling tests (already use mocks)

**What unit tests cover:**
- ✅ Conditional logic (default parameters, branching)
- ✅ Validation logic (shape checks, error conditions)
- ✅ Error handling (return structure, error propagation)
- ✅ Parameter transformation logic
- ❌ Pass-through (parameter forwarding - too trivial)

**What uvisbox_interface tests cover:**
- Real UVisBox integration (already sufficient in `tests/uvisbox_interface/`)

**Impact:**
- `tests/unit/test_tools.py`: ~50 tests → ~44-52 tests
- All unit tests run without UVisBox installation
- Test execution: significantly faster
- API budget: unchanged (0 LLM calls in unit tests)

---

## Test Categories by Tool Type

### Visualization Tools (vis_tools.py)

Each vis tool has these non-trivial logic paths:

1. **Default parameter application**
   - Example: `percentiles=None` → defaults to `[25, 50, 90, 100]`

2. **Data loading error propagation**
   - `load_array()` returns `success=False` → function returns error dict

3. **Shape validation**
   - Example: `curves.ndim != 2` → returns error with helpful message

4. **UVisBox exception handling**
   - UVisBox raises exception → caught, returns error dict with `_error_details`

5. **Return structure validation**
   - Success: `{"status": "success", "message": ..., "_vis_params": {...}}`
   - Error: `{"status": "error", "message": ..., "_error_details": ...}`

**Test count:** 6 vis tools × 4-5 tests = ~24-30 tests

### Data Tools (data_tools.py)

Non-trivial logic paths:

1. **Parameter validation** (n_curves > 0, etc.)
2. **File save error handling** (`np.save()` fails)
3. **CSV loading errors** (file not found, pandas errors, conversion errors)
4. **Session cleanup logic** (clear_session removes temp files)

**Test count:** ~8-10 tests

---

## Mock Strategy

### What to Mock

**For vis_tools tests:**
```python
@patch('uvisbox_assistant.tools.vis_tools.functional_boxplot')  # Mock UVisBox
@patch('uvisbox_assistant.utils.data_loading.load_array')      # Mock data loading
def test_plot_functional_boxplot_logic(mock_load_array, mock_uvisbox):
    ...
```

**For data_tools tests:**
```python
@patch('numpy.save')  # Mock file I/O
def test_generate_curves_save_failure(mock_save):
    ...

@patch('pandas.read_csv')  # Mock CSV reading
def test_load_csv_pandas_error(mock_read_csv):
    ...
```

### Mock Return Values

**load_array() patterns:**
```python
# Success case
mock_load_array.return_value = (True, np.random.rand(10, 50), None)

# Error case
mock_load_array.return_value = (False, None, "File not found: curves.npy")

# Wrong shape case (for validation testing)
mock_load_array.return_value = (True, np.random.rand(10, 50, 3), None)
```

**UVisBox patterns:**
```python
# Success case - returns None (mutates ax in-place)
mock_uvisbox.return_value = None

# Exception case
mock_uvisbox.side_effect = RuntimeError("UVisBox internal error")
```

### Test Structure Pattern

**Template for each vis tool:**
```python
class TestPlotFunctionalBoxplot:
    """Unit tests for plot_functional_boxplot (0 UVisBox calls)."""

    @patch('uvisbox_assistant.tools.vis_tools.functional_boxplot')
    @patch('uvisbox_assistant.utils.data_loading.load_array')
    def test_default_percentiles_applied(self, mock_load, mock_uvisbox):
        """Test percentiles=None applies default [25, 50, 90, 100]."""
        ...

    @patch('uvisbox_assistant.tools.vis_tools.functional_boxplot')
    @patch('uvisbox_assistant.utils.data_loading.load_array')
    def test_data_loading_error_propagated(self, mock_load, mock_uvisbox):
        """Test load_array error returns error dict."""
        ...

    @patch('uvisbox_assistant.tools.vis_tools.functional_boxplot')
    @patch('uvisbox_assistant.utils.data_loading.load_array')
    def test_wrong_shape_validation(self, mock_load, mock_uvisbox):
        """Test 3D array rejected with error message."""
        ...

    @patch('uvisbox_assistant.tools.vis_tools.functional_boxplot')
    @patch('uvisbox_assistant.utils.data_loading.load_array')
    def test_uvisbox_exception_handled(self, mock_load, mock_uvisbox):
        """Test UVisBox exception caught and returned as error dict."""
        ...
```

---

## File Organization and Migration

### Current State
```
tests/unit/test_tools.py (689 lines)
├── Data Tools Tests
│   └── ~3 tests (call real generation)
│
├── Visualization Tools Tests
│   └── ~40 tests (call real UVisBox)
│
└── Exception Handling Tests
    └── ~12 tests (@patch - KEEP)
```

### New Structure
```
tests/unit/test_tools.py (estimated ~400 lines)
├── Data Tools Unit Tests
│   ├── TestGenerateEnsembleCurves
│   ├── TestGenerateScalarField
│   ├── TestGenerateVectorField
│   ├── TestLoadCSV
│   └── TestClearSession
│
├── Visualization Tools Unit Tests
│   ├── TestPlotFunctionalBoxplot
│   ├── TestPlotCurveBoxplot
│   ├── TestPlotContourBoxplot
│   ├── TestPlotProbabilisticMS
│   ├── TestPlotUncertaintyLobes
│   └── TestPlotSquidGlyph2D
│
└── [Keep existing exception handling tests]
```

### Migration Actions

**DELETE:** ~35-40 tests that call real UVisBox/data generation

**KEEP:** ~12 tests with `@patch` decorators (already mocked)

**ADD:** ~32-40 new mocked logic tests

**Net result:** ~50 tests → ~44-52 tests (proper unit tests)

---

## Success Criteria

1. ✅ All `tests/unit/` tests pass without UVisBox installed
2. ✅ All non-trivial logic paths have test coverage
3. ✅ `python tests/test.py --pre-planning` runs successfully without UVisBox
4. ✅ Test execution time significantly faster
5. ✅ Code coverage maintained at ≥89%

---

## Non-Goals

- Modify source code in `vis_tools.py` or `data_tools.py`
- Add try/except or lazy imports
- Change `tests/uvisbox_interface/` (already sufficient)
- Test trivial pass-through logic
