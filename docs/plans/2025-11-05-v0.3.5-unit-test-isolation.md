# v0.3.5 Unit Test Isolation Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Make `tests/unit/test_tools.py` run without UVisBox installation by replacing all real UVisBox calls with mocked tests.

**Architecture:** Delete ~40 tests calling real UVisBox, keep ~9 tests with existing mocks, add ~35 new mocked tests covering non-trivial logic paths (defaults, validation, error handling).

**Tech Stack:** pytest, unittest.mock, numpy

---

## Task 1: Prepare Test File Structure

**Files:**
- Modify: `tests/unit/test_tools.py`

**Step 1: Add module-level comment explaining changes**

At the top of the file, after imports, add:

```python
# ============================================================================
# Unit Tests for data_tools and vis_tools (0 UVisBox calls)
#
# These tests mock all external dependencies (UVisBox, file I/O) to test
# wrapper logic in isolation:
# - Default parameter application
# - Validation logic
# - Error handling and propagation
# - Return structure correctness
#
# Real UVisBox integration is tested in tests/uvisbox_interface/
# ============================================================================
```

**Step 2: Commit preparation**

```bash
git add tests/unit/test_tools.py
git commit -m "docs: add unit test isolation header to test_tools.py"
```

---

## Task 2: Delete Tests Calling Real UVisBox (Data Tools)

**Files:**
- Modify: `tests/unit/test_tools.py:34-81`

**Step 1: Delete data generation tests**

Delete these functions (lines 34-81):
- `test_generate_ensemble_curves()`
- `test_generate_scalar_field_ensemble()`
- `test_generate_vector_field_ensemble()`

**Step 2: Verify deletion**

Run: `grep -n "def test_generate_ensemble_curves\|def test_generate_scalar_field_ensemble\|def test_generate_vector_field_ensemble" tests/unit/test_tools.py`

Expected: No results (empty output)

**Step 3: Commit deletion**

```bash
git add tests/unit/test_tools.py
git commit -m "test: delete data tool tests calling real generation"
```

---

## Task 3: Delete Tests Calling Real UVisBox (Vis Tools Part 1)

**Files:**
- Modify: `tests/unit/test_tools.py:85-250`

**Step 1: Delete visualization tests with real calls**

Delete these functions:
- `test_plot_functional_boxplot_with_styling()` (line 85)
- `test_plot_curve_boxplot_with_workers()` (line 125)
- `test_plot_contour_boxplot_full_params()` (line 147)
- `test_plot_probabilistic_marching_squares()` (line 178)
- `test_plot_uncertainty_lobes()` (line 196)
- `test_plot_squid_glyph_2D()` (line 217)
- `test_default_percentiles()` (line 238)
- `test_vis_params_structure()` (line 255)

**Step 2: Commit deletion**

```bash
git add tests/unit/test_tools.py
git commit -m "test: delete vis tool tests calling real UVisBox (part 1)"
```

---

## Task 4: Delete Tests Calling Real UVisBox (Vis Tools Part 2)

**Files:**
- Modify: `tests/unit/test_tools.py` (remaining real UVisBox calls)

**Step 1: Delete validation tests with real calls**

Delete these functions:
- `test_plot_functional_boxplot_file_not_found()` (line 379)
- `test_plot_functional_boxplot_invalid_shape()` (line 388)
- `test_plot_curve_boxplot_file_not_found()` (line 401)
- `test_plot_contour_boxplot_file_not_found()` (line 410)
- `test_plot_contour_boxplot_invalid_shape()` (line 419)
- `test_plot_probabilistic_marching_squares_file_not_found()` (line 432)
- `test_plot_uncertainty_lobes_file_not_found()` (line 441)
- `test_plot_squid_glyph_file_not_found()` (line 453)
- `test_plot_probabilistic_marching_squares_invalid_shape()` (line 481)
- `test_plot_uncertainty_lobes_shape_mismatch()` (line 494)
- `test_plot_squid_glyph_shape_mismatch()` (line 509)
- `test_plot_curve_boxplot_invalid_shape()` (line 523)
- `test_plot_curve_boxplot_with_defaults()` (line 536)
- `test_plot_uncertainty_lobes_with_defaults()` (line 588)
- `test_plot_squid_glyph_with_defaults()` (line 605)

**Step 2: Commit deletion**

```bash
git add tests/unit/test_tools.py
git commit -m "test: delete vis tool tests calling real UVisBox (part 2)"
```

---

## Task 5: Delete CSV/NPY Loading Tests with Real I/O

**Files:**
- Modify: `tests/unit/test_tools.py`

**Step 1: Delete CSV/NPY tests with real file operations**

Delete these functions:
- `test_load_csv_file_not_found()` (around line 287)
- `test_load_csv_success()` (around line 296)
- `test_load_npy_file_not_found()` (around line 316)
- `test_load_npy_success()` (around line 325)
- `test_load_npy_invalid_file()` (around line 340)
- `test_generate_scalar_field_edge_case_constant()` (around line 353)
- `test_generate_vector_field_small_grid()` (around line 365)
- `test_load_csv_malformed()` (around line 465)
- `test_clear_session_with_files()` (around line 556)
- `test_clear_session_no_temp_dir()` (around line 570)

**Step 2: Commit deletion**

```bash
git add tests/unit/test_tools.py
git commit -m "test: delete CSV/NPY loading tests with real I/O"
```

---

## Task 6: Add Mocked Tests for plot_functional_boxplot

**Files:**
- Modify: `tests/unit/test_tools.py`

**Step 1: Add test class after imports section**

After the module-level comment (added in Task 1), add:

```python
# ============================================================================
# Visualization Tools - Mocked Unit Tests
# ============================================================================

class TestPlotFunctionalBoxplot:
    """Unit tests for plot_functional_boxplot (0 UVisBox calls)."""

    @patch('uvisbox_assistant.tools.vis_tools.functional_boxplot')
    @patch('uvisbox_assistant.utils.data_loading.load_array')
    def test_default_percentiles_applied(self, mock_load_array, mock_uvisbox):
        """Test percentiles=None applies default [25, 50, 90, 100]."""
        # Arrange
        mock_load_array.return_value = (True, np.random.rand(10, 50), None)
        mock_uvisbox.return_value = None

        # Act
        result = plot_functional_boxplot(data_path="curves.npy")

        # Assert
        assert result['status'] == 'success'
        assert result['_vis_params']['percentiles'] == [25, 50, 90, 100]

    @patch('uvisbox_assistant.tools.vis_tools.functional_boxplot')
    @patch('uvisbox_assistant.utils.data_loading.load_array')
    def test_custom_percentiles_preserved(self, mock_load_array, mock_uvisbox):
        """Test custom percentiles are not overridden."""
        # Arrange
        mock_load_array.return_value = (True, np.random.rand(10, 50), None)
        mock_uvisbox.return_value = None

        # Act
        result = plot_functional_boxplot(
            data_path="curves.npy",
            percentiles=[10, 50, 90]
        )

        # Assert
        assert result['status'] == 'success'
        assert result['_vis_params']['percentiles'] == [10, 50, 90]

    @patch('uvisbox_assistant.tools.vis_tools.functional_boxplot')
    @patch('uvisbox_assistant.utils.data_loading.load_array')
    def test_data_loading_error_propagated(self, mock_load_array, mock_uvisbox):
        """Test load_array error returns error dict."""
        # Arrange
        mock_load_array.return_value = (False, None, "File not found: curves.npy")

        # Act
        result = plot_functional_boxplot(data_path="curves.npy")

        # Assert
        assert result['status'] == 'error'
        assert "File not found" in result['message']
        # UVisBox should never be called if loading fails
        mock_uvisbox.assert_not_called()

    @patch('uvisbox_assistant.tools.vis_tools.functional_boxplot')
    @patch('uvisbox_assistant.utils.data_loading.load_array')
    def test_wrong_shape_validation(self, mock_load_array, mock_uvisbox):
        """Test 3D array rejected with error message."""
        # Arrange - return 3D array instead of required 2D
        mock_load_array.return_value = (True, np.random.rand(10, 50, 3), None)

        # Act
        result = plot_functional_boxplot(data_path="curves.npy")

        # Assert
        assert result['status'] == 'error'
        assert '2D' in result['message'] or 'shape' in result['message'].lower()
        # UVisBox should never be called if validation fails
        mock_uvisbox.assert_not_called()

    @patch('uvisbox_assistant.tools.vis_tools.functional_boxplot')
    @patch('uvisbox_assistant.utils.data_loading.load_array')
    def test_uvisbox_exception_handled(self, mock_load_array, mock_uvisbox):
        """Test UVisBox exception caught and returned as error dict."""
        # Arrange
        mock_load_array.return_value = (True, np.random.rand(10, 50), None)
        mock_uvisbox.side_effect = RuntimeError("UVisBox internal error")

        # Act
        result = plot_functional_boxplot(data_path="curves.npy")

        # Assert
        assert result['status'] == 'error'
        assert 'error' in result['message'].lower()
        assert '_error_details' in result
```

**Step 2: Run tests to verify they pass**

Run: `poetry run pytest tests/unit/test_tools.py::TestPlotFunctionalBoxplot -v`

Expected: 5 tests PASS

**Step 3: Commit**

```bash
git add tests/unit/test_tools.py
git commit -m "test: add mocked unit tests for plot_functional_boxplot"
```

---

## Remaining Tasks Summary

Due to length constraints, remaining tasks follow the same pattern:

**Tasks 7-11:** Add mocked test classes for:
- `TestPlotCurveBoxplot` (5 tests)
- `TestPlotContourBoxplot` (4 tests)
- `TestPlotProbabilisticMarchingSquares` (4 tests)
- `TestPlotUncertaintyLobes` (4 tests)
- `TestPlotSquidGlyph2D` (4 tests)

**Task 12:** Add mocked test classes for data tools:
- `TestGenerateEnsembleCurves` (1 test)
- `TestGenerateScalarField` (1 test)
- `TestGenerateVectorField` (1 test)
- `TestLoadCSV` (2 tests)
- `TestClearSession` (2 tests)

**Task 13:** Verify all unit tests pass without UVisBox

**Task 14:** Update TESTING.md documentation

**Task 15:** Update CHANGELOG.md

**Task 16:** Version bump to 0.3.5

---

## Success Criteria

- ✅ All unit tests pass without UVisBox installed
- ✅ `python tests/test.py --pre-planning` runs without UVisBox (unit tests pass, uvisbox_interface fails as expected)
- ✅ Test execution time < 5 seconds for unit tests
- ✅ ~280 unit tests total
- ✅ Code coverage maintained at ≥89%
- ✅ Documentation updated (TESTING.md, CHANGELOG.md)
- ✅ Version bumped to 0.3.5
