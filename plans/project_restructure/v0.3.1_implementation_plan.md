# v0.3.1 Implementation Plan: Project Restructure (Feature-Based Architecture)

## Overview

**Version**: v0.3.1
**Feature**: Project Restructure - Feature-Based Architecture
**Approach**: Single-Phase Atomic Migration
**Estimated Time**: 3-4 hours
**Risk Level**: Low (pure refactoring, zero functional changes)

## Goals

1. Reorganize 21 Python files from flat structure into 6 feature-based subdirectories
2. Maintain 100% backward compatibility for all public APIs
3. Preserve git history using `git mv`
4. Update all internal imports automatically
5. Keep all tests passing (77+ unit tests, 0 API calls)
6. Zero functional changes (pure structural refactoring)

## Current State

```
src/uvisbox_assistant/
‚îú‚îÄ‚îÄ __init__.py, __main__.py, main.py, config.py
‚îú‚îÄ‚îÄ graph.py, nodes.py, routing.py, state.py
‚îú‚îÄ‚îÄ data_tools.py, vis_tools.py, statistics_tools.py, analyzer_tools.py
‚îú‚îÄ‚îÄ conversation.py, hybrid_control.py, command_parser.py
‚îú‚îÄ‚îÄ model.py
‚îú‚îÄ‚îÄ error_tracking.py, error_interpretation.py
‚îî‚îÄ‚îÄ logger.py, output_control.py, utils.py

Total: 21 files, 4,731 lines
```

## Target State (Option 1: Feature-Based Structure)

```
src/uvisbox_assistant/
‚îú‚îÄ‚îÄ __init__.py              # Re-exports all public APIs (backward compatibility)
‚îú‚îÄ‚îÄ __main__.py              # Entry point (unchanged)
‚îú‚îÄ‚îÄ main.py                  # REPL (imports updated)
‚îú‚îÄ‚îÄ config.py                # Configuration (unchanged)
‚îÇ
‚îú‚îÄ‚îÄ core/                    # LangGraph workflow orchestration
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py          # Clean exports
‚îÇ   ‚îú‚îÄ‚îÄ graph.py             # StateGraph definition
‚îÇ   ‚îú‚îÄ‚îÄ nodes.py             # 5 nodes (model, data, vis, statistics, analyzer)
‚îÇ   ‚îú‚îÄ‚îÄ routing.py           # Conditional routing with circuit breaker
‚îÇ   ‚îî‚îÄ‚îÄ state.py             # GraphState with analysis fields
‚îÇ
‚îú‚îÄ‚îÄ tools/                   # Data generation and visualization tools
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py          # Clean exports
‚îÇ   ‚îú‚îÄ‚îÄ data_tools.py        # Data loading/generation
‚îÇ   ‚îú‚îÄ‚îÄ vis_tools.py         # Visualization wrappers (BoxplotStyleConfig)
‚îÇ   ‚îú‚îÄ‚îÄ statistics_tools.py  # Statistical analysis (v0.3.0)
‚îÇ   ‚îî‚îÄ‚îÄ analyzer_tools.py    # LLM-powered reports (v0.3.0)
‚îÇ
‚îú‚îÄ‚îÄ session/                 # User interaction and session management
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py          # Clean exports
‚îÇ   ‚îú‚îÄ‚îÄ conversation.py      # ConversationSession class
‚îÇ   ‚îú‚îÄ‚îÄ hybrid_control.py    # Fast parameter updates
‚îÇ   ‚îî‚îÄ‚îÄ command_parser.py    # Command parsing (16 patterns)
‚îÇ
‚îú‚îÄ‚îÄ llm/                     # LLM configuration and setup
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py          # Clean exports
‚îÇ   ‚îî‚îÄ‚îÄ model.py             # Gemini model with error recovery
‚îÇ
‚îú‚îÄ‚îÄ errors/                  # Error handling infrastructure
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py          # Clean exports
‚îÇ   ‚îú‚îÄ‚îÄ error_tracking.py    # ErrorRecord and error storage
‚îÇ   ‚îî‚îÄ‚îÄ error_interpretation.py  # Context-aware error hints
‚îÇ
‚îî‚îÄ‚îÄ utils/                   # Utilities and logging
    ‚îú‚îÄ‚îÄ __init__.py          # Clean exports
    ‚îú‚îÄ‚îÄ logger.py            # Logging infrastructure
    ‚îú‚îÄ‚îÄ output_control.py    # Verbose mode control
    ‚îî‚îÄ‚îÄ utils.py             # Utility functions
```

## Benefits

1. **Clear Feature Boundaries**: Each subdirectory has a single responsibility
2. **Improved Discoverability**: New developers can quickly find relevant code
3. **Better Scalability**: Easy to add new modules to appropriate directories
4. **Reduced Cognitive Load**: ~3-4 files per directory vs 21 files in one directory
5. **Maintains Backward Compatibility**: All existing imports continue working
6. **Git History Preserved**: Using `git mv` maintains file history

## Pre-Migration Checklist

Before starting the migration, verify the current state:

```bash
# 1. Verify git status is clean
git status

# 2. Create a backup branch
git checkout -b backup-before-restructure

# 3. Switch back to feature branch
git checkout feature/v0.3.0-uncertainty-analyzer

# 4. Run all tests to ensure baseline
python tests/utils/run_all_tests.py --unit

# 5. Count current files
ls -1 src/uvisbox_assistant/*.py | wc -l  # Should be 21

# 6. Verify no uncommitted changes
git diff --exit-code
```

## Implementation Steps

### Step 1.1: Create Directory Structure

```bash
cd src/uvisbox_assistant

mkdir -p core
mkdir -p tools
mkdir -p session
mkdir -p llm
mkdir -p errors
mkdir -p utils
```

**Verification**:
```bash
ls -ld */  # Should show 6 directories
```

### Step 1.2: Move Files with git mv (Preserve History)

**Core directory** (4 files):
```bash
git mv graph.py core/
git mv nodes.py core/
git mv routing.py core/
git mv state.py core/
```

**Tools directory** (4 files):
```bash
git mv data_tools.py tools/
git mv vis_tools.py tools/
git mv statistics_tools.py tools/
git mv analyzer_tools.py tools/
```

**Session directory** (3 files):
```bash
git mv conversation.py session/
git mv hybrid_control.py session/
git mv command_parser.py session/
```

**LLM directory** (1 file):
```bash
git mv model.py llm/
```

**Errors directory** (2 files):
```bash
git mv error_tracking.py errors/
git mv error_interpretation.py errors/
```

**Utils directory** (3 files):
```bash
git mv logger.py utils/
git mv output_control.py utils/
git mv utils.py utils/
```

**Verification**:
```bash
# Check git recognizes moves
git status | grep renamed  # Should show 17 renames

# Verify root files remain
ls -1 *.py  # Should show: __init__.py, __main__.py, main.py, config.py
```

### Step 1.3: Create Backward-Compatible Root __init__.py

Update `/src/uvisbox_assistant/__init__.py`:

```python
"""
UVisBox-Assistant - Natural language interface for UVisBox uncertainty visualization.

This package uses a feature-based architecture with backward-compatible imports.

Public API Structure:
- Core workflow: graph_app, create_graph
- Session management: ConversationSession
- Tools: All data and visualization tools
- Error handling: ErrorRecord
"""

# Core workflow (from core/)
from uvisbox_assistant.core.graph import graph_app, create_graph

# Session management (from session/)
from uvisbox_assistant.session.conversation import ConversationSession

# Data tools (from tools/)
from uvisbox_assistant.tools.data_tools import (
    generate_ensemble_curves,
    generate_scalar_field_ensemble,
    generate_vector_field_ensemble,
    load_csv_to_numpy,
    load_npy,
    clear_session,
)

# Visualization tools (from tools/)
from uvisbox_assistant.tools.vis_tools import (
    plot_functional_boxplot,
    plot_curve_boxplot,
    plot_probabilistic_marching_squares,
    plot_contour_boxplot,
    plot_uncertainty_lobes,
    plot_squid_glyph_2D,
)

# Statistics tools (from tools/, v0.3.0)
from uvisbox_assistant.tools.statistics_tools import (
    compute_functional_boxplot_statistics,
)

# Analyzer tools (from tools/, v0.3.0)
from uvisbox_assistant.tools.analyzer_tools import (
    generate_uncertainty_report,
)

# Error tracking (from errors/, v0.1.2)
from uvisbox_assistant.errors.error_tracking import ErrorRecord

# Configuration (root)
from uvisbox_assistant.config import (
    GEMINI_API_KEY,
    TEMP_DIR,
    TEST_DATA_DIR,
    LOG_DIR,
    DEFAULT_VIS_PARAMS,
)

__all__ = [
    # Core
    "graph_app",
    "create_graph",
    # Session
    "ConversationSession",
    # Data Tools
    "generate_ensemble_curves",
    "generate_scalar_field_ensemble",
    "generate_vector_field_ensemble",
    "load_csv_to_numpy",
    "load_npy",
    "clear_session",
    # Visualization Tools
    "plot_functional_boxplot",
    "plot_curve_boxplot",
    "plot_probabilistic_marching_squares",
    "plot_contour_boxplot",
    "plot_uncertainty_lobes",
    "plot_squid_glyph_2D",
    # Statistics Tools
    "compute_functional_boxplot_statistics",
    # Analyzer Tools
    "generate_uncertainty_report",
    # Error Tracking
    "ErrorRecord",
    # Config
    "GEMINI_API_KEY",
    "TEMP_DIR",
    "TEST_DATA_DIR",
    "LOG_DIR",
    "DEFAULT_VIS_PARAMS",
]

__version__ = "0.3.1"
```

**Why this works**: Legacy imports like `from uvisbox_assistant.conversation import ConversationSession` will fail, but the recommended import `from uvisbox_assistant import ConversationSession` continues working.

### Step 1.4: Create Subdirectory __init__.py Files

**`core/__init__.py`**:
```python
"""Core LangGraph workflow orchestration."""

from uvisbox_assistant.core.graph import graph_app, create_graph
from uvisbox_assistant.core.nodes import call_model, call_data_tool, call_vis_tool, call_statistics_tool, call_analyzer_tool
from uvisbox_assistant.core.routing import route_after_model, route_after_tool
from uvisbox_assistant.core.state import GraphState, create_initial_state, update_state_with_data, update_state_with_vis, increment_error_count

__all__ = [
    "graph_app",
    "create_graph",
    "call_model",
    "call_data_tool",
    "call_vis_tool",
    "call_statistics_tool",
    "call_analyzer_tool",
    "route_after_model",
    "route_after_tool",
    "GraphState",
    "create_initial_state",
    "update_state_with_data",
    "update_state_with_vis",
    "increment_error_count",
]
```

**`tools/__init__.py`**:
```python
"""Data generation, visualization, statistics, and analysis tools."""

from uvisbox_assistant.tools.data_tools import (
    generate_ensemble_curves,
    generate_scalar_field_ensemble,
    generate_vector_field_ensemble,
    load_csv_to_numpy,
    load_npy,
    clear_session,
    DATA_TOOL_SCHEMAS,
)

from uvisbox_assistant.tools.vis_tools import (
    plot_functional_boxplot,
    plot_curve_boxplot,
    plot_probabilistic_marching_squares,
    plot_contour_boxplot,
    plot_uncertainty_lobes,
    plot_squid_glyph_2D,
    VIS_TOOL_SCHEMAS,
)

from uvisbox_assistant.tools.statistics_tools import (
    compute_functional_boxplot_statistics,
    STATISTICS_TOOL_SCHEMAS,
)

from uvisbox_assistant.tools.analyzer_tools import (
    generate_uncertainty_report,
    ANALYZER_TOOL_SCHEMAS,
)

__all__ = [
    # Data tools
    "generate_ensemble_curves",
    "generate_scalar_field_ensemble",
    "generate_vector_field_ensemble",
    "load_csv_to_numpy",
    "load_npy",
    "clear_session",
    "DATA_TOOL_SCHEMAS",
    # Visualization tools
    "plot_functional_boxplot",
    "plot_curve_boxplot",
    "plot_probabilistic_marching_squares",
    "plot_contour_boxplot",
    "plot_uncertainty_lobes",
    "plot_squid_glyph_2D",
    "VIS_TOOL_SCHEMAS",
    # Statistics tools
    "compute_functional_boxplot_statistics",
    "STATISTICS_TOOL_SCHEMAS",
    # Analyzer tools
    "generate_uncertainty_report",
    "ANALYZER_TOOL_SCHEMAS",
]
```

**`session/__init__.py`**:
```python
"""User interaction and session management."""

from uvisbox_assistant.session.conversation import ConversationSession
from uvisbox_assistant.session.hybrid_control import execute_simple_command
from uvisbox_assistant.session.command_parser import parse_simple_command

__all__ = [
    "ConversationSession",
    "execute_simple_command",
    "parse_simple_command",
]
```

**`llm/__init__.py`**:
```python
"""LLM configuration and setup."""

from uvisbox_assistant.llm.model import model_with_tools, create_model

__all__ = [
    "model_with_tools",
    "create_model",
]
```

**`errors/__init__.py`**:
```python
"""Error handling infrastructure."""

from uvisbox_assistant.errors.error_tracking import ErrorRecord
from uvisbox_assistant.errors.error_interpretation import interpret_uvisbox_error, format_error_with_hint

__all__ = [
    "ErrorRecord",
    "interpret_uvisbox_error",
    "format_error_with_hint",
]
```

**`utils/__init__.py`**:
```python
"""Utilities and logging."""

from uvisbox_assistant.utils.logger import log_tool_call, log_tool_result, log_error, log_state_update
from uvisbox_assistant.utils.output_control import vprint, set_session
from uvisbox_assistant.utils.utils import is_data_tool, is_vis_tool, is_statistics_tool, is_analyzer_tool

__all__ = [
    # Logger
    "log_tool_call",
    "log_tool_result",
    "log_error",
    "log_state_update",
    # Output control
    "vprint",
    "set_session",
    # Utils
    "is_data_tool",
    "is_vis_tool",
    "is_statistics_tool",
    "is_analyzer_tool",
]
```

### Step 1.5: Automated Import Updater Script

Create `/scripts/update_imports.py`:

```python
#!/usr/bin/env python3
"""
Automated import updater for v0.3.1 project restructure.

Updates all internal imports from flat structure to feature-based structure.
"""

import re
from pathlib import Path
from typing import Dict, List, Tuple

# Import mapping: old_import ‚Üí new_import
IMPORT_MAPPINGS: Dict[str, str] = {
    # Core
    "from uvisbox_assistant.graph import": "from uvisbox_assistant.core.graph import",
    "from uvisbox_assistant.nodes import": "from uvisbox_assistant.core.nodes import",
    "from uvisbox_assistant.routing import": "from uvisbox_assistant.core.routing import",
    "from uvisbox_assistant.state import": "from uvisbox_assistant.core.state import",
    "import uvisbox_assistant.graph": "import uvisbox_assistant.core.graph",
    "import uvisbox_assistant.nodes": "import uvisbox_assistant.core.nodes",
    "import uvisbox_assistant.routing": "import uvisbox_assistant.core.routing",
    "import uvisbox_assistant.state": "import uvisbox_assistant.core.state",

    # Tools
    "from uvisbox_assistant.data_tools import": "from uvisbox_assistant.tools.data_tools import",
    "from uvisbox_assistant.vis_tools import": "from uvisbox_assistant.tools.vis_tools import",
    "from uvisbox_assistant.statistics_tools import": "from uvisbox_assistant.tools.statistics_tools import",
    "from uvisbox_assistant.analyzer_tools import": "from uvisbox_assistant.tools.analyzer_tools import",
    "import uvisbox_assistant.data_tools": "import uvisbox_assistant.tools.data_tools",
    "import uvisbox_assistant.vis_tools": "import uvisbox_assistant.tools.vis_tools",
    "import uvisbox_assistant.statistics_tools": "import uvisbox_assistant.tools.statistics_tools",
    "import uvisbox_assistant.analyzer_tools": "import uvisbox_assistant.tools.analyzer_tools",

    # Session
    "from uvisbox_assistant.conversation import": "from uvisbox_assistant.session.conversation import",
    "from uvisbox_assistant.hybrid_control import": "from uvisbox_assistant.session.hybrid_control import",
    "from uvisbox_assistant.command_parser import": "from uvisbox_assistant.session.command_parser import",
    "import uvisbox_assistant.conversation": "import uvisbox_assistant.session.conversation",
    "import uvisbox_assistant.hybrid_control": "import uvisbox_assistant.session.hybrid_control",
    "import uvisbox_assistant.command_parser": "import uvisbox_assistant.session.command_parser",

    # LLM
    "from uvisbox_assistant.model import": "from uvisbox_assistant.llm.model import",
    "import uvisbox_assistant.model": "import uvisbox_assistant.llm.model",

    # Errors
    "from uvisbox_assistant.error_tracking import": "from uvisbox_assistant.errors.error_tracking import",
    "from uvisbox_assistant.error_interpretation import": "from uvisbox_assistant.errors.error_interpretation import",
    "import uvisbox_assistant.error_tracking": "import uvisbox_assistant.errors.error_tracking",
    "import uvisbox_assistant.error_interpretation": "import uvisbox_assistant.errors.error_interpretation",

    # Utils
    "from uvisbox_assistant.logger import": "from uvisbox_assistant.utils.logger import",
    "from uvisbox_assistant.output_control import": "from uvisbox_assistant.utils.output_control import",
    "from uvisbox_assistant.utils import": "from uvisbox_assistant.utils.utils import",
    "import uvisbox_assistant.logger": "import uvisbox_assistant.utils.logger",
    "import uvisbox_assistant.output_control": "import uvisbox_assistant.utils.output_control",
}

def update_file_imports(file_path: Path, dry_run: bool = False) -> Tuple[int, List[str]]:
    """
    Update imports in a single file.

    Returns:
        (number_of_changes, list_of_changes)
    """
    with open(file_path, 'r') as f:
        content = f.read()

    original_content = content
    changes = []

    for old_import, new_import in IMPORT_MAPPINGS.items():
        if old_import in content:
            content = content.replace(old_import, new_import)
            changes.append(f"{old_import} ‚Üí {new_import}")

    num_changes = len(changes)

    if num_changes > 0 and not dry_run:
        with open(file_path, 'w') as f:
            f.write(content)

    return num_changes, changes

def main():
    """Update all imports in the codebase."""
    import argparse

    parser = argparse.ArgumentParser(description="Update imports for v0.3.1 restructure")
    parser.add_argument("--dry-run", action="store_true", help="Show changes without modifying files")
    args = parser.parse_args()

    # Files to update
    src_dir = Path("src/uvisbox_assistant")
    test_dir = Path("tests")

    # Find all Python files
    py_files = list(src_dir.rglob("*.py")) + list(test_dir.rglob("*.py"))
    py_files.append(Path("main.py"))  # Root main.py

    total_files_changed = 0
    total_changes = 0

    print(f"{'DRY RUN - ' if args.dry_run else ''}Updating imports in {len(py_files)} files...")
    print()

    for py_file in py_files:
        num_changes, changes = update_file_imports(py_file, dry_run=args.dry_run)

        if num_changes > 0:
            total_files_changed += 1
            total_changes += num_changes
            print(f"‚úì {py_file} ({num_changes} changes)")
            for change in changes:
                print(f"  - {change}")
            print()

    print(f"{'Would update' if args.dry_run else 'Updated'} {total_changes} imports in {total_files_changed} files")

    if args.dry_run:
        print("\nRun without --dry-run to apply changes")

if __name__ == "__main__":
    main()
```

**Usage**:
```bash
# Preview changes
python scripts/update_imports.py --dry-run

# Apply changes
python scripts/update_imports.py
```

**Expected**: ~127 import updates across ~32 files

### Step 1.6: Update Test Imports

**Strategy**: Use top-level imports from root `__init__.py` to minimize test changes.

**Example update** (`tests/unit/test_command_parser.py`):
```python
# OLD
from uvisbox_assistant.command_parser import parse_simple_command

# NEW (preferred - uses root __init__.py)
from uvisbox_assistant.session.command_parser import parse_simple_command

# OR (also works via root __init__.py re-export)
from uvisbox_assistant import ConversationSession
```

**Manual verification** for complex test files:
- `tests/integration/test_hybrid_control.py`
- `tests/e2e/test_analysis_workflows.py`
- `tests/interactive/interactive_test.py`

### Step 1.7: Backward Compatibility Verification Script

Create `/scripts/verify_compatibility.py`:

```python
#!/usr/bin/env python3
"""
Verify backward compatibility after restructure.

Tests that all legacy import patterns still work via root __init__.py.
"""

def test_legacy_imports():
    """Test that legacy imports work."""

    # Core imports
    from uvisbox_assistant import graph_app, create_graph
    from uvisbox_assistant import ConversationSession

    # Data tools
    from uvisbox_assistant import (
        generate_ensemble_curves,
        load_csv_to_numpy,
        load_npy,
    )

    # Visualization tools
    from uvisbox_assistant import (
        plot_functional_boxplot,
        plot_curve_boxplot,
    )

    # Statistics tools (v0.3.0)
    from uvisbox_assistant import compute_functional_boxplot_statistics

    # Analyzer tools (v0.3.0)
    from uvisbox_assistant import generate_uncertainty_report

    # Error tracking
    from uvisbox_assistant import ErrorRecord

    # Config
    from uvisbox_assistant import TEMP_DIR, TEST_DATA_DIR

    print("‚úì All legacy imports successful!")
    return True

def test_new_imports():
    """Test that new structured imports work."""

    # Core
    from uvisbox_assistant.core import graph_app
    from uvisbox_assistant.session import ConversationSession

    # Tools
    from uvisbox_assistant.tools import generate_ensemble_curves
    from uvisbox_assistant.tools import plot_functional_boxplot
    from uvisbox_assistant.tools import compute_functional_boxplot_statistics
    from uvisbox_assistant.tools import generate_uncertainty_report

    # Errors
    from uvisbox_assistant.errors import ErrorRecord

    print("‚úì All new imports successful!")
    return True

if __name__ == "__main__":
    print("Testing backward compatibility...")
    test_legacy_imports()
    print()
    print("Testing new structured imports...")
    test_new_imports()
    print()
    print("‚úì All compatibility tests passed!")
```

**Usage**:
```bash
python scripts/verify_compatibility.py
```

### Step 1.8: Run Full Test Suite

```bash
# Run all unit tests (0 API calls, instant)
python tests/utils/run_all_tests.py --unit

# Expected: 77+ tests pass, 0 failures

# Optional: Run integration tests (with delays)
python tests/utils/run_all_tests.py --integration
```

**If tests fail**:
1. Check import errors first (most likely cause)
2. Run individual test files to isolate issue
3. Use `--dry-run` mode on import updater to verify mappings
4. Check subdirectory `__init__.py` exports are complete

### Step 1.9: Update Documentation

Update 6 documentation files with new file paths:

**CLAUDE.md** (lines 73-89, 983-1026):
- Update "Key Components" section with subdirectory paths
- Update file structure diagram
- Add note about backward compatibility imports

**README.md** (lines 177-191):
- Update "Project Structure" section

**docs/API.md** (if it references file paths):
- Update any file path references

**TESTING.md** (if it references file paths):
- Update test structure documentation

**CHANGELOG.md**:
- Add v0.3.1 entry documenting the restructure

**docs/USER_GUIDE.md** (if it references file paths):
- Update any code examples with file paths

### Step 1.10: Manual Verification Checklist

Before committing, verify:

- [ ] All 17 files moved with `git mv` (preserves history)
- [ ] 6 subdirectories created with `__init__.py` files
- [ ] Root `__init__.py` re-exports all public APIs
- [ ] Import updater script ran successfully (~127 changes)
- [ ] All unit tests pass (77+ tests, 0 failures)
- [ ] Backward compatibility script passes
- [ ] Documentation updated with new paths
- [ ] No functional changes (purely structural)
- [ ] `git status` shows 17 renames + additions + modifications
- [ ] Can import from both legacy and new paths

**Quick verification commands**:
```bash
# Test legacy import
python -c "from uvisbox_assistant import ConversationSession; print('‚úì Legacy import works')"

# Test new import
python -c "from uvisbox_assistant.session import ConversationSession; print('‚úì New import works')"

# Run quick test
python tests/test_simple.py

# Check git recognizes file moves
git log --follow src/uvisbox_assistant/core/graph.py  # Should show full history
```

### Step 1.11: Atomic Commit

```bash
git add .

git commit -m "Restructure project to feature-based architecture for v0.3.1

Reorganize 21 Python files from flat structure into 6 feature-based subdirectories:
- core/ - LangGraph workflow (graph, nodes, routing, state)
- tools/ - Data, vis, statistics, analyzer tools
- session/ - Conversation, hybrid control, command parser
- llm/ - Model configuration
- errors/ - Error tracking and interpretation
- utils/ - Logger, output control, utilities

Changes:
- Move 17 files using git mv (preserves history)
- Create 6 subdirectory __init__.py files with clean exports
- Update root __init__.py to re-export all public APIs (backward compatibility)
- Update ~127 imports across 32 files (automated via scripts/update_imports.py)
- Update 6 documentation files with new file paths
- Add 2 verification scripts (update_imports.py, verify_compatibility.py)

Testing:
- ‚úì All 77+ unit tests pass (0 API calls)
- ‚úì Backward compatibility verified (legacy imports work)
- ‚úì New structured imports verified
- ‚úì No functional changes (pure refactoring)

Benefits:
- Clear feature boundaries (3-4 files per directory vs 21 in one)
- Improved discoverability for new developers
- Better scalability for future features
- Reduced cognitive load
- 100% backward compatible

ü§ñ Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>"
```

## Rollback Strategy

If issues are discovered after migration:

### Option 1: Git Revert (Atomic)
```bash
# Revert the migration commit
git revert HEAD

# All files return to original structure
# Tests should pass immediately
```

### Option 2: Reset to Backup Branch
```bash
# Switch to backup branch created in pre-migration
git checkout backup-before-restructure

# Create new branch from backup
git checkout -b fix-migration-issue

# Cherry-pick specific fixes if needed
git cherry-pick <commit-sha>
```

### Option 3: Manual Rollback
```bash
# Move files back to root
cd src/uvisbox_assistant
git mv core/*.py .
git mv tools/*.py .
git mv session/*.py .
git mv llm/*.py .
git mv errors/*.py .
git mv utils/*.py .

# Remove subdirectories
rm -rf core/ tools/ session/ llm/ errors/ utils/

# Restore old __init__.py from git history
git checkout HEAD~1 -- __init__.py

# Commit rollback
git add .
git commit -m "Rollback project restructure to flat structure"
```

## Risk Assessment

### Low Risk Items ‚úÖ

1. **Git History Preservation**: Using `git mv` ensures full history is maintained
2. **Backward Compatibility**: Root `__init__.py` re-exports maintain all legacy imports
3. **Automated Updates**: Script handles 95% of import updates automatically
4. **Test Coverage**: 77+ unit tests verify no functional regressions
5. **Atomic Migration**: Single commit allows easy revert if needed
6. **Zero Functional Changes**: Pure structural refactoring, no logic changes

### Medium Risk Items ‚ö†Ô∏è

1. **Import Edge Cases**: Some complex imports may need manual verification
   - **Mitigation**: Dry-run mode shows all changes before applying
   - **Mitigation**: Backward compatibility script tests common patterns

2. **IDE Auto-Import**: IDEs may auto-import from new paths
   - **Mitigation**: Both old and new paths work via re-exports
   - **Mitigation**: Update IDE settings to prefer top-level imports

3. **Documentation Lag**: Docs may briefly reference old paths
   - **Mitigation**: All 6 doc files updated in same commit
   - **Mitigation**: Search-and-replace verification before commit

### High Risk Items ‚ùå

**None identified.** This is a low-risk refactoring due to:
- Automated tooling
- Comprehensive test coverage
- Backward compatibility guarantees
- Easy rollback options

## Success Criteria

The migration is successful when:

1. ‚úÖ All 17 files moved to correct subdirectories with `git mv`
2. ‚úÖ All 77+ unit tests pass with 0 failures
3. ‚úÖ Backward compatibility script passes (legacy imports work)
4. ‚úÖ New import paths verified (structured imports work)
5. ‚úÖ Git history preserved (`git log --follow` shows full history)
6. ‚úÖ Documentation updated with new file paths
7. ‚úÖ No functional changes (pure refactoring)
8. ‚úÖ Main REPL runs without errors
9. ‚úÖ Interactive test menu loads successfully
10. ‚úÖ Simple test passes (1-2 API calls)

**Acceptance Test**:
```bash
# Should all pass without errors
python -c "from uvisbox_assistant import ConversationSession"
python tests/test_simple.py
python tests/utils/run_all_tests.py --unit
python main.py  # Type /quit to exit
```

## Timeline Estimate

| Phase | Task | Time |
|-------|------|------|
| **Preparation** | Pre-migration checklist, backup branch | 15 min |
| **Step 1.1-1.2** | Create directories, move files | 15 min |
| **Step 1.3-1.4** | Create `__init__.py` files (7 files) | 30 min |
| **Step 1.5** | Create import updater script | 30 min |
| **Step 1.6** | Run import updater, manual verification | 30 min |
| **Step 1.7-1.8** | Create compatibility script, run tests | 20 min |
| **Step 1.9** | Update documentation (6 files) | 30 min |
| **Step 1.10** | Manual verification checklist | 20 min |
| **Step 1.11** | Commit with detailed message | 10 min |
| **Total** | | **3-4 hours** |

## Post-Migration Tasks

1. **Monitor for Issues**: Watch for import errors in next development session
2. **Update IDE Settings**: Configure IDE to prefer top-level imports
3. **Team Communication**: Notify collaborators of new structure
4. **Update .github/**: Update any CI/CD references to file paths
5. **Consider PyPI Release**: v0.3.1 with improved architecture

## Notes

- This is a **single-phase atomic migration** (not incremental)
- All changes in **one commit** for easy rollback
- **Zero functional changes** - pure structural refactoring
- **100% backward compatible** via root `__init__.py`
- Estimated **127 import updates** across **32 files**
- All **77+ unit tests** must pass before commit
- Git history **fully preserved** with `git mv`

## Questions for Review

1. Should we rename any modules during migration? (e.g., `utils.py` ‚Üí `helpers.py`)
2. Should we add type stubs (`*.pyi`) while restructuring?
3. Should we update `pyproject.toml` with new package structure?
4. Should we add `py.typed` marker for type checking?
5. Should we create a migration guide for users upgrading from v0.3.0?

---

**Next Steps**: Review plan, execute migration, verify tests, commit changes.
